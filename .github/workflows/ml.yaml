name: Build and Push ML Job

on:
  push:
    branches: [ master ]
    paths:
      - 'ml-rule-generator/**'

env:
  REGISTRY: quay.io
  QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}

permissions:
  contents: write

jobs:
  build-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Quay.io
      uses: docker/login-action@v3
      with:
        registry: quay.io
        username: ${{ env.QUAY_USERNAME }}
        password: ${{ secrets.QUAY_TOKEN }}

    - name: Extract short SHA
      id: sha
      run: echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Build and push ml-generator
      uses: docker/build-push-action@v5
      with:
        context: ./ml-rule-generator
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.QUAY_USERNAME }}/ml-generator:${{ steps.sha.outputs.SHORT_SHA }}
          ${{ env.REGISTRY }}/${{ env.QUAY_USERNAME }}/ml-generator:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Update Kubernetes manifests
      run: |
        # Update image tags in Kubernetes manifests
        sed -i "s|image: quay.io/anatheobald/ml-generator:.*|image: quay.io/anatheobald/ml-generator:${{ steps.sha.outputs.SHORT_SHA }}|" argocd/job.yaml
        # sed -i "s/^\(\s*name:\s*\)ml-generator-job[-a-z0-9]*/\1ml-generator-job-${{ steps.sha.outputs.SHORT_SHA }}/" argocd/job.yaml
        # Commit and push changes
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add argocd/job.yaml
        git commit -m "ci: update to images ${{ steps.sha.outputs.SHORT_SHA }}" || exit 0
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}